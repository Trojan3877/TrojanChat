package com.trojanchat

import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import android.widget.Button
import android.widget.EditText
import android.widget.TextView
import kotlinx.coroutines.*
import okhttp3.*
import org.json.JSONObject
import java.io.IOException

class MainActivity : AppCompatActivity() {

    private val client = OkHttpClient()
    private val API_URL = "http://10.0.2.2:8000"  // Android emulator â†’ localhost

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        val usernameField = findViewById<EditText>(R.id.usernameField)
        val messageField = findViewById<EditText>(R.id.messageField)
        val sendButton = findViewById<Button>(R.id.sendButton)
        val chatBox = findViewById<TextView>(R.id.chatBox)

        sendButton.setOnClickListener {
            val username = usernameField.text.toString()
            val message = messageField.text.toString()

            if (username.isNotEmpty() && message.isNotEmpty()) {
                sendMessage(username, message)
                messageField.text.clear()
            }
        }

        // Auto-refresh messages every 3 seconds
        CoroutineScope(Dispatchers.IO).launch {
            while (isActive) {
                fetchMessages { messages ->
                    runOnUiThread {
                        chatBox.text = messages
                    }
                }
                delay(3000)
            }
        }
    }

    private fun sendMessage(username: String, content: String) {
        val json = JSONObject()
        json.put("username", username)
        json.put("content", content)

        val body = RequestBody.create(
            MediaType.parse("application/json; charset=utf-8"),
            json.toString()
        )

        val request = Request.Builder()
            .url("$API_URL/chat/send")
            .post(body)
            .build()

        client.newCall(request).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {}
            override fun onResponse(call: Call, response: Response) {}
        })
    }

    private fun fetchMessages(callback: (String) -> Unit) {
        val request = Request.Builder()
            .url("$API_URL/chat/history?limit=30")
            .build()

        client.newCall(request).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {}
            override fun onResponse(call: Call, response: Response) {
                val bodyString = response.body()?.string() ?: ""
                callback(formatMessages(bodyString))
            }
        })
    }

    private fun formatMessages(json: String): String {
        val arr = JSONObject("{\"data\":$json}").getJSONArray("data")
        val builder = StringBuilder()

        for (i in 0 until arr.length()) {
            val msg = arr.getJSONObject(i)
            builder.append("[${msg.getString("username")}] ${msg.getString("content")}\n")
        }
        return builder.toString()
    }
}
